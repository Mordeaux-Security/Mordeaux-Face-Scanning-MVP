<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Combined Site Image Analyzer</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .site-section {
            margin: 30px 0;
            padding: 20px;
            border: 2px solid #dee2e6;
            border-radius: 8px;
        }
        .wikifeet-section {
            border-color: #007bff;
        }
        .candidshiny-section {
            border-color: #dc3545;
        }
        button {
            background: #6c757d;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            margin: 10px 5px;
        }
        button:hover {
            background: #5a6268;
        }
        button:disabled {
            background: #6c757d;
            cursor: not-allowed;
            opacity: 0.6;
        }
        .wikifeet-btn {
            background: #007bff;
        }
        .wikifeet-btn:hover {
            background: #0056b3;
        }
        .candidshiny-btn {
            background: #dc3545;
        }
        .candidshiny-btn:hover {
            background: #c82333;
        }
        .analyze-all-btn {
            background: #28a745;
            font-size: 18px;
            padding: 15px 30px;
        }
        .analyze-all-btn:hover {
            background: #218838;
        }
        .results {
            margin-top: 20px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 4px;
            border-left: 4px solid #6c757d;
        }
        .error {
            background: #f8d7da;
            border-left-color: #dc3545;
            color: #721c24;
        }
        .success {
            background: #d4edda;
            border-left-color: #28a745;
            color: #155724;
        }
        .warning {
            background: #fff3cd;
            border-left-color: #ffc107;
            color: #856404;
        }
        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 10px;
            margin: 15px 0;
        }
        .stat-box {
            background: white;
            padding: 10px;
            border-radius: 4px;
            border: 1px solid #dee2e6;
            text-align: center;
        }
        .stat-number {
            font-size: 20px;
            font-weight: bold;
            color: #6c757d;
        }
        .stat-label {
            font-size: 12px;
            color: #6c757d;
            margin-top: 5px;
        }
        .loading {
            display: none;
            text-align: center;
            padding: 20px;
        }
        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #6c757d;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
            margin: 0 auto;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .comparison {
            margin: 30px 0;
            padding: 20px;
            background: #e9ecef;
            border-radius: 8px;
        }
        .comparison-table {
            width: 100%;
            border-collapse: collapse;
            margin: 15px 0;
        }
        .comparison-table th,
        .comparison-table td {
            border: 1px solid #dee2e6;
            padding: 8px 12px;
            text-align: left;
        }
        .comparison-table th {
            background: #f8f9fa;
            font-weight: bold;
        }
        .recommendations {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 4px;
            font-family: monospace;
            font-size: 14px;
            white-space: pre-wrap;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Combined Site Image Analyzer</h1>
        <p>This tool analyzes both wikifeet.com and candidshiny.com to understand their image structures and provide recommendations for the crawler.</p>
        
        <div style="text-align: center; margin: 30px 0;">
            <button onclick="analyzeAllSites()" class="analyze-all-btn" id="analyzeAllBtn">Analyze Both Sites</button>
            <button onclick="clearAllResults()" id="clearAllBtn">Clear All Results</button>
        </div>
        
        <div class="loading" id="loading">
            <div class="spinner"></div>
            <p id="loadingText">Analyzing sites...</p>
        </div>
        
        <!-- WikiFeet Section -->
        <div class="site-section wikifeet-section">
            <h2>WikiFeet.com Analysis</h2>
            <p>Analyzing wikifeet.com for image structure and extraction patterns.</p>
            
            <button onclick="analyzeWikifeet()" class="wikifeet-btn" id="wikifeetBtn">Analyze WikiFeet</button>
            <button onclick="clearWikifeetResults()" id="clearWikifeetBtn">Clear</button>
            
            <div id="wikifeetResults"></div>
        </div>
        
        <!-- CandidShiny Section -->
        <div class="site-section candidshiny-section">
            <h2>CandidShiny.com Analysis</h2>
            <p>Analyzing candidshiny.com with redirect prevention to understand image structure.</p>
            
            <button onclick="analyzeCandidshiny()" class="candidshiny-btn" id="candidshinyBtn">Analyze CandidShiny</button>
            <button onclick="clearCandidshinyResults()" id="clearCandidshinyBtn">Clear</button>
            
            <div id="candidshinyResults"></div>
        </div>
        
        <!-- Comparison Section -->
        <div class="comparison" id="comparisonSection" style="display: none;">
            <h2>Site Comparison & Recommendations</h2>
            <div id="comparisonResults"></div>
        </div>
    </div>

    <script>
        let wikifeetData = null;
        let candidshinyData = null;

        async function analyzeAllSites() {
            const loadingDiv = document.getElementById('loading');
            const loadingText = document.getElementById('loadingText');
            const analyzeAllBtn = document.getElementById('analyzeAllBtn');
            
            loadingDiv.style.display = 'block';
            analyzeAllBtn.disabled = true;
            
            try {
                loadingText.textContent = 'Analyzing WikiFeet...';
                await analyzeWikifeet();
                
                loadingText.textContent = 'Analyzing CandidShiny...';
                await analyzeCandidshiny();
                
                loadingText.textContent = 'Generating comparison...';
                generateComparison();
                
            } catch (error) {
                console.error('Analysis failed:', error);
            } finally {
                loadingDiv.style.display = 'none';
                analyzeAllBtn.disabled = false;
            }
        }

        async function analyzeWikifeet() {
            const resultsDiv = document.getElementById('wikifeetResults');
            const analyzeBtn = document.getElementById('wikifeetBtn');
            
            analyzeBtn.disabled = true;
            resultsDiv.innerHTML = '<div class="loading"><div class="spinner"></div><p>Analyzing WikiFeet...</p></div>';
            
            try {
                console.log('Starting WikiFeet analysis...');
                
                const proxies = [
                    'https://corsproxy.io/?',
                    'https://api.allorigins.win/raw?url=',
                    'https://cors-anywhere.herokuapp.com/',
                    'https://thingproxy.freeboard.io/fetch/'
                ];
                
                let html = null;
                let proxyUsed = null;
                
                for (const proxy of proxies) {
                    try {
                        console.log(`Trying proxy: ${proxy}`);
                        const response = await fetch(proxy + encodeURIComponent('https://wikifeet.com'), {
                            method: 'GET',
                            headers: {
                                'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36'
                            }
                        });
                        
                        if (response.ok) {
                            html = await response.text();
                            proxyUsed = proxy;
                            console.log(`Success with proxy: ${proxy}`);
                            break;
                        }
                    } catch (error) {
                        console.log(`Proxy ${proxy} failed:`, error.message);
                        continue;
                    }
                }
                
                if (!html) {
                    throw new Error('All CORS proxies failed');
                }
                
                const parser = new DOMParser();
                const doc = parser.parseFromString(html, 'text/html');
                wikifeetData = analyzeImages(doc, 'wikifeet', proxyUsed);
                
                displayWikifeetResults(wikifeetData);
                
            } catch (error) {
                console.error('WikiFeet analysis failed:', error);
                resultsDiv.innerHTML = `
                    <div class="results error">
                        <h3>WikiFeet Analysis Failed</h3>
                        <p><strong>Error:</strong> ${error.message}</p>
                        <p>Try opening browser DevTools and running manual analysis.</p>
                    </div>
                `;
            } finally {
                analyzeBtn.disabled = false;
            }
        }

        async function analyzeCandidshiny() {
            const resultsDiv = document.getElementById('candidshinyResults');
            const analyzeBtn = document.getElementById('candidshinyBtn');
            
            analyzeBtn.disabled = true;
            resultsDiv.innerHTML = '<div class="loading"><div class="spinner"></div><p>Analyzing CandidShiny...</p></div>';
            
            try {
                console.log('Starting CandidShiny analysis...');
                
                // Try manual redirect first
                try {
                    const response = await fetch('https://candidshiny.com', {
                        method: 'GET',
                        redirect: 'manual',
                        headers: {
                            'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36'
                        }
                    });
                    
                    if (response.type === 'opaqueredirect' || response.status === 301 || response.status === 302) {
                        const location = response.headers.get('location');
                        candidshinyData = {
                            success: false,
                            redirect: true,
                            status: response.status,
                            location: location,
                            message: `Redirect detected: ${response.status} to ${location || 'unknown'}`
                        };
                        displayCandidshinyResults(candidshinyData);
                        return;
                    } else if (response.ok) {
                        const html = await response.text();
                        const parser = new DOMParser();
                        const doc = parser.parseFromString(html, 'text/html');
                        candidshinyData = analyzeImages(doc, 'candidshiny');
                        displayCandidshinyResults(candidshinyData);
                        return;
                    }
                } catch (error) {
                    console.log('Manual redirect failed, trying proxy...');
                }
                
                // Try proxy if manual fails
                const proxies = [
                    'https://corsproxy.io/?',
                    'https://api.allorigins.win/raw?url='
                ];
                
                for (const proxy of proxies) {
                    try {
                        const response = await fetch(proxy + encodeURIComponent('https://candidshiny.com'));
                        if (response.ok) {
                            const html = await response.text();
                            const parser = new DOMParser();
                            const doc = parser.parseFromString(html, 'text/html');
                            candidshinyData = analyzeImages(doc, 'candidshiny', proxy);
                            displayCandidshinyResults(candidshinyData);
                            return;
                        }
                    } catch (error) {
                        continue;
                    }
                }
                
                throw new Error('All methods failed');
                
            } catch (error) {
                console.error('CandidShiny analysis failed:', error);
                candidshinyData = {
                    success: false,
                    error: error.message
                };
                displayCandidshinyResults(candidshinyData);
            } finally {
                analyzeBtn.disabled = false;
            }
        }

        function analyzeImages(doc, site, proxy = null) {
            const imgs = doc.querySelectorAll('img');
            const pictures = doc.querySelectorAll('picture');
            const sources = doc.querySelectorAll('source');
            
            const imgAnalysis = Array.from(imgs).map((img, index) => {
                const attributes = {};
                for (const attr of img.attributes) {
                    attributes[attr.name] = attr.value;
                }
                return {
                    index: index + 1,
                    attributes: attributes,
                    hasSrc: !!img.src,
                    hasDataSrc: !!img.getAttribute('data-src'),
                    hasDataTn: !!img.getAttribute('data-tn'),
                    hasSrcset: !!img.getAttribute('srcset'),
                    hasLazyAttrs: Object.keys(attributes).some(key => key.startsWith('data-'))
                };
            });
            
            const allDataAttrs = new Set();
            imgs.forEach(img => {
                for (const attr of img.attributes) {
                    if (attr.name.startsWith('data-')) {
                        allDataAttrs.add(attr.name);
                    }
                }
            });
            
            return {
                site: site,
                success: true,
                proxy: proxy,
                stats: {
                    totalImgs: imgs.length,
                    totalPictures: pictures.length,
                    totalSources: sources.length,
                    uniqueDataAttrs: allDataAttrs.size
                },
                imgs: imgAnalysis,
                dataAttributes: Array.from(allDataAttrs).sort(),
                htmlLength: doc.documentElement.outerHTML.length
            };
        }

        function displayWikifeetResults(data) {
            const resultsDiv = document.getElementById('wikifeetResults');
            
            resultsDiv.innerHTML = `
                <div class="results success">
                    <h3>WikiFeet Analysis Complete</h3>
                    <p><strong>Proxy:</strong> ${data.proxy || 'Direct'}</p>
                    <p><strong>HTML length:</strong> ${data.htmlLength.toLocaleString()} characters</p>
                </div>
                
                <div class="stats">
                    <div class="stat-box">
                        <div class="stat-number">${data.stats.totalImgs}</div>
                        <div class="stat-label">IMG Tags</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-number">${data.stats.totalPictures}</div>
                        <div class="stat-label">PICTURE Tags</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-number">${data.stats.totalSources}</div>
                        <div class="stat-label">SOURCE Tags</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-number">${data.stats.uniqueDataAttrs}</div>
                        <div class="stat-label">Data Attributes</div>
                    </div>
                </div>
                
                <div class="results">
                    <h4>Data Attributes Found</h4>
                    <div style="font-family: monospace; background: #f8f9fa; padding: 10px; border-radius: 4px;">
                        ${data.dataAttributes.length > 0 ? 
                            data.dataAttributes.map(attr => `<span style="color: #007bff; font-weight: bold;">${attr}</span>`).join(', ') : 
                            'No data attributes found'
                        }
                    </div>
                </div>
                
                <div class="results">
                    <h4>Sample Images</h4>
                    <div style="max-height: 200px; overflow-y: auto; font-family: monospace; font-size: 12px;">
                        ${data.imgs.slice(0, 5).map(img => `
                            <div style="padding: 5px; border-bottom: 1px solid #eee;">
                                <strong>Image ${img.index}:</strong><br>
                                ${Object.entries(img.attributes).map(([key, value]) => 
                                    `<span style="color: #007bff;">${key}</span>="${value}"`
                                ).join(' ')}<br>
                                <small>Has src: ${img.hasSrc}, Has data-src: ${img.hasDataSrc}, Has srcset: ${img.hasSrcset}</small>
                            </div>
                        `).join('')}
                        ${data.imgs.length > 5 ? `<div style="padding: 5px; color: #6c757d;">... and ${data.imgs.length - 5} more</div>` : ''}
                    </div>
                </div>
            `;
        }

        function displayCandidshinyResults(data) {
            const resultsDiv = document.getElementById('candidshinyResults');
            
            if (!data.success) {
                resultsDiv.innerHTML = `
                    <div class="results error">
                        <h3>CandidShiny Analysis Failed</h3>
                        <p><strong>Error:</strong> ${data.error || data.message}</p>
                        ${data.location ? `<p><strong>Redirect Location:</strong> ${data.location}</p>` : ''}
                        <p><strong>Conclusion:</strong> Site appears to be dead/blocked and redirects to external services.</p>
                    </div>
                `;
                return;
            }
            
            resultsDiv.innerHTML = `
                <div class="results success">
                    <h3>CandidShiny Analysis Complete</h3>
                    <p><strong>Method:</strong> ${data.proxy ? 'Proxy' : 'Direct'}</p>
                    <p><strong>HTML length:</strong> ${data.htmlLength.toLocaleString()} characters</p>
                </div>
                
                <div class="stats">
                    <div class="stat-box">
                        <div class="stat-number">${data.stats.totalImgs}</div>
                        <div class="stat-label">IMG Tags</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-number">${data.stats.totalPictures}</div>
                        <div class="stat-label">PICTURE Tags</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-number">${data.stats.totalSources}</div>
                        <div class="stat-label">SOURCE Tags</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-number">${data.stats.uniqueDataAttrs}</div>
                        <div class="stat-label">Data Attributes</div>
                    </div>
                </div>
                
                <div class="results">
                    <h4>Data Attributes Found</h4>
                    <div style="font-family: monospace; background: #f8f9fa; padding: 10px; border-radius: 4px;">
                        ${data.dataAttributes.length > 0 ? 
                            data.dataAttributes.map(attr => `<span style="color: #dc3545; font-weight: bold;">${attr}</span>`).join(', ') : 
                            'No data attributes found'
                        }
                    </div>
                </div>
            `;
        }

        function generateComparison() {
            if (!wikifeetData || !candidshinyData) return;
            
            const comparisonSection = document.getElementById('comparisonSection');
            const comparisonResults = document.getElementById('comparisonResults');
            
            comparisonSection.style.display = 'block';
            
            const wikifeetSuccess = wikifeetData.success;
            const candidshinySuccess = candidshinyData.success;
            
            comparisonResults.innerHTML = `
                <table class="comparison-table">
                    <thead>
                        <tr>
                            <th>Metric</th>
                            <th>WikiFeet</th>
                            <th>CandidShiny</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td><strong>Analysis Status</strong></td>
                            <td>${wikifeetSuccess ? '✅ Success' : '❌ Failed'}</td>
                            <td>${candidshinySuccess ? '✅ Success' : '❌ Failed'}</td>
                        </tr>
                        <tr>
                            <td><strong>IMG Tags</strong></td>
                            <td>${wikifeetSuccess ? wikifeetData.stats.totalImgs : 'N/A'}</td>
                            <td>${candidshinySuccess ? candidshinyData.stats.totalImgs : 'N/A'}</td>
                        </tr>
                        <tr>
                            <td><strong>PICTURE Tags</strong></td>
                            <td>${wikifeetSuccess ? wikifeetData.stats.totalPictures : 'N/A'}</td>
                            <td>${candidshinySuccess ? candidshinyData.stats.totalPictures : 'N/A'}</td>
                        </tr>
                        <tr>
                            <td><strong>Data Attributes</strong></td>
                            <td>${wikifeetSuccess ? wikifeetData.stats.uniqueDataAttrs : 'N/A'}</td>
                            <td>${candidshinySuccess ? candidshinyData.stats.uniqueDataAttrs : 'N/A'}</td>
                        </tr>
                        <tr>
                            <td><strong>HTML Length</strong></td>
                            <td>${wikifeetSuccess ? wikifeetData.htmlLength.toLocaleString() : 'N/A'}</td>
                            <td>${candidshinySuccess ? candidshinyData.htmlLength.toLocaleString() : 'N/A'}</td>
                        </tr>
                    </tbody>
                </table>
                
                <div class="results">
                    <h3>Final Recommendations for selector_miner.py</h3>
                    <div class="recommendations">${generateFinalRecommendations()}</div>
                </div>
            `;
        }

        function generateFinalRecommendations() {
            let recommendations = [];
            
            recommendations.push('# Image Extraction Recommendations');
            recommendations.push('# Based on analysis of wikifeet.com and candidshiny.com');
            recommendations.push('');
            
            if (wikifeetData && wikifeetData.success) {
                recommendations.push('# WikiFeet.com findings:');
                recommendations.push(`# - Found ${wikifeetData.stats.totalImgs} img tags`);
                recommendations.push(`# - Found ${wikifeetData.stats.totalPictures} picture tags`);
                recommendations.push(`# - Found ${wikifeetData.stats.uniqueDataAttrs} unique data attributes`);
                
                if (wikifeetData.dataAttributes.length > 0) {
                    recommendations.push('# - Data attributes found:');
                    wikifeetData.dataAttributes.forEach(attr => {
                        recommendations.push(`#   ${attr}`);
                    });
                }
                recommendations.push('');
            }
            
            if (candidshinyData) {
                if (candidshinyData.success) {
                    recommendations.push('# CandidShiny.com findings:');
                    recommendations.push(`# - Found ${candidshinyData.stats.totalImgs} img tags`);
                    recommendations.push(`# - Found ${candidshinyData.stats.uniqueDataAttrs} unique data attributes`);
                    
                    if (candidshinyData.dataAttributes.length > 0) {
                        recommendations.push('# - Data attributes found:');
                        candidshinyData.dataAttributes.forEach(attr => {
                            recommendations.push(`#   ${attr}`);
                        });
                    }
                } else {
                    recommendations.push('# CandidShiny.com findings:');
                    recommendations.push('# - Site is dead/blocked (redirects to external services)');
                    recommendations.push('# - No image extraction needed for this site');
                }
                recommendations.push('');
            }
            
            recommendations.push('# Recommended updates to selector_miner.py:');
            recommendations.push('');
            
            // Collect all unique data attributes
            const allDataAttrs = new Set();
            if (wikifeetData && wikifeetData.success) {
                wikifeetData.dataAttributes.forEach(attr => allDataAttrs.add(attr));
            }
            if (candidshinyData && candidshinyData.success) {
                candidshinyData.dataAttributes.forEach(attr => allDataAttrs.add(attr));
            }
            
            if (allDataAttrs.size > 0) {
                recommendations.push('# 1. Add these data attributes to lazy_attrs list:');
                Array.from(allDataAttrs).sort().forEach(attr => {
                    recommendations.push(`'${attr}',`);
                });
                recommendations.push('');
            }
            
            recommendations.push('# 2. Ensure these features are enabled:');
            recommendations.push('# - nc_extract_data_attributes = True');
            recommendations.push('# - nc_extract_srcset_images = True');
            recommendations.push('# - nc_extract_background_images = True');
            recommendations.push('');
            
            recommendations.push('# 3. For wikifeet.com specifically:');
            if (wikifeetData && wikifeetData.success && wikifeetData.stats.totalImgs > 0) {
                recommendations.push('# - Site has images but current selectors may not match');
                recommendations.push('# - Consider adding site-specific selectors if needed');
            } else {
                recommendations.push('# - Site may use non-standard image loading');
                recommendations.push('# - May require JavaScript execution to reveal images');
            }
            
            return recommendations.join('\n');
        }

        function clearWikifeetResults() {
            document.getElementById('wikifeetResults').innerHTML = '';
            wikifeetData = null;
        }

        function clearCandidshinyResults() {
            document.getElementById('candidshinyResults').innerHTML = '';
            candidshinyData = null;
        }

        function clearAllResults() {
            clearWikifeetResults();
            clearCandidshinyResults();
            document.getElementById('comparisonSection').style.display = 'none';
        }
    </script>
</body>
</html>
